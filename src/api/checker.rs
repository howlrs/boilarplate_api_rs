use axum::{
    Json,
    extract::{Path, path},
    http::response,
    response::IntoResponse,
};
use log::info;
use reqwest::StatusCode;
use serde::{Deserialize, Serialize};
use serde_json::{Value, json};

use crate::{api::utils::response_handler, common, models::claim::Claims};

#[derive(Debug, Clone, Deserialize, Serialize)]
pub struct PathParams {
    // [gemini, claude, chatgpt]
    pub target_ai: String,
    // [mail, summary, etc  ]
    pub prompt_type: String,
}

pub async fn switcher(
    claims: Claims,
    Path(path_params): Path<PathParams>,
    Json(body): Json<Value>,
) -> impl IntoResponse {
    let start = std::time::Instant::now();

    if claims.is_ok() {
        info!("claims: {:?}", claims);
        println!(
            "user_id: {}, ai: {}, work: {}",
            claims.user_id, path_params.target_ai, path_params.prompt_type,
        )
    } else {
        return response_handler(
            StatusCode::UNAUTHORIZED,
            "unauthorized".to_string(),
            None,
            Some("Unauthorized".to_string()),
        );
    }

    let message = body["message"].as_str().unwrap_or_default();
    if message.is_empty() {
        return response_handler(
            StatusCode::BAD_REQUEST,
            "error".to_string(),
            None,
            Some("message is empty".to_string()),
        );
    }

    // AIの種類によって処理を分岐
    match path_params.target_ai.as_str() {
        "gemini" => {
            // prompt_typeで分岐したリクエストコンテンツが生成される
            let content = create_request(&path_params.prompt_type, message);
            info!("{}", content);
            match common::gemini::request(&content).await {
                Ok(response) => {
                    let model = response["model"].as_str().unwrap_or_default();
                    let result = response["result"].as_str().unwrap_or_default();

                    let result = markdown::to_html(result);

                    response_handler(
                        StatusCode::OK,
                        "success".to_string(),
                        Some(json!({
                            "model": model,
                            "result": result,
                            "elapsed": start.elapsed().as_secs(),
                        })),
                        None,
                    )
                }
                Err(err) => response_handler(
                    StatusCode::BAD_REQUEST,
                    "error".to_string(),
                    None,
                    Some(err.to_string()),
                ),
            }
        }
        _ => response_handler(
            StatusCode::BAD_REQUEST,
            "error".to_string(),
            None,
            Some("target_ai is not supported".to_string()),
        ),
    }
}

/// プロンプトタイプからリクエストコンテンツを生成する関数
pub fn create_request(prompt_type: &str, str: &str) -> String {
    match prompt_type {
        // メールリファクタリング
        "mail" => check_mail_for_client(str),
        // 議事録作成
        "meeting" => create_meeting_doc(str),
        // 整合性チェック
        "integrity" => check_integrity(str),
        _ => check_mail_for_client(str),
    }
}

/// クライアントに対するメール構文のリファクタリング
fn check_mail_for_client(content: &str) -> String {
    format!(
        r##"# AIによる社外クライアント向けメールのチェック・リファクタリング指示

## あなたの役割 (AI Role)
あなたは、経験豊富なビジネスコミュニケーションコンサルタントです。特に社外クライアントとの円滑かつ効果的なメールコミュニケーションを専門としています。丁寧さ、明確さ、戦略性を重視し、受け手に好印象を与え、ビジネス目標の達成に貢献するメールを作成するスキルを持っています。

## 目的 (Goal)
以下の「元のメール文章」を、社外クライアント向けのコミュニケーション・ビジネスメールとして最高品質のレベルにリファクタリングしてください。単なる修正だけでなく、より効果的で洗練されたコミュニケーションを実現するための改善提案も期待します。

## 推測される背景情報 (Inferred Context - AIが抽出)
※ **元のメール文章から読み解き**、以下の項目を**可能な限り推測**してください。**推測が困難な場合や情報が不足している場合は、最も一般的で丁寧さが求められるビジネスシーン（例：既存クライアントへの標準的な連絡、トーンは標準的ビジネス）を想定**してください。

*   **メールの主な目的:** (例: アポイントメント依頼、製品紹介、問い合わせへの回答、お礼、謝罪、進捗報告、提案、見積もり送付など)
*   **クライアントとの関係性:** (例: 新規、既存（取引期間短い）、既存（長年の付き合い）、潜在顧客など)
*   **緊急度・重要度:** (例: 高・中・低)
*   **特に伝えたい/強調したい点:**
*   **想定されるべきトーン:** (例: 非常に丁寧、標準的ビジネス、やや親しみやすく、緊急性を出す など)
*   **その他特記事項:** (例: 過去の経緯、避けるべき表現、含めるべき必須情報など)

## 元のメール文章 (Original Email Text)
```
{}
```

## リファクタリングの際の品質基準 & チェック項目 (Quality Standards & Checklist)
**上記で推測した背景情報を踏まえ**、以下の全ての基準を満たすように、元のメール文章をチェックし、必要に応じてリファクタリングしてください。

1.  **目的の明確性:**
    *   メールの目的（何をしてほしいのか、何を伝えたいのか）が一読して明確に理解できるか？
    *   主題（Subject/件名）は具体的で分かりやすいか？
2.  **正確性:**
    *   誤字脱字、文法的な誤りがないか？
    *   固有名詞（社名、氏名、製品名など）、日付、数値に間違いはないか？
3.  **明瞭性・誤解防止:**
    *   専門用語や略語が不必要に使われていないか？（必要な場合は注釈があるか？）
    *   曖昧な表現や多義的な表現がなく、一意に解釈できるか？
    *   一文が長すぎず、簡潔か？
4.  **丁寧さ・礼儀正しさ:**
    *   クライアントに対する敬意が示されており、適切な敬語（尊敬語・謙譲語・丁寧語）が使われているか？
    *   クッション言葉が効果的に使われているか？
    *   高圧的、一方的な印象を与えないか？
    *   （推測した）クライアントとの関係性に応じた適切な丁寧さか？
5.  **構成・論理性:**
    *   文章全体の流れ（挨拶→本題→結び）が自然で論理的か？
    *   情報の提示順序は適切か？
    *   段落分けは適切に行われているか？
    *   接続詞は効果的に使われているか？
6.  **情報網羅性・強調:**
    *   伝えるべき重要な情報（5W1Hなど）に漏れはないか？
    *   特に重要な情報は、箇条書きや太字などで適切に強調されているか？（過度な強調は避ける）
    *   次のアクション（返信依頼、資料確認依頼など）が必要な場合、それが明確に示されているか？
7.  **語彙・表現:**
    *   ビジネスシーンにふさわしい語彙が選択されているか？
    *   定型的すぎず、かつ、相手に合わせた配慮が見られる表現か？
    *   情報の整合性（本文と件名、添付ファイルとの整合性など）は取れているか？
8.  **文章量:**
    *   冗長な表現がなく、目的達成のために必要十分な長さか？
    *   簡潔さと丁寧さのバランスは取れているか？
9.  **推測背景との整合性:**
    *   AI自身が推測した「背景情報」が、リファクタリング後の文章に矛盾なく反映されているか？

## 出力形式 (Output Format)
以下の形式で出力し、必ずリファクタリング後のメール文章を出力文頭にしてください。

1.  **リファクタリング後のメール文章:**
    ※ 文章内に複数回出現する未記入のワードは文頭に変数を設けて一括置換可能にしてください。

    ```
    (リファクタリング後の本文)
    ```
2. **出力時に推測した背景情報（Inferred Context）:** (AIが推測した背景情報を元に、リファクタリング後のメール文章に反映されているか確認するための情報。)
2.  **リファクタリングのポイント:** (どのような点を変更・修正したかの要約)
3.  **リファクタリングの理由:** (各変更・修正が、上記の品質基準や**推測した背景情報**に基づいてなぜ必要だったかの具体的な説明。**推測した背景情報（目的、関係性、トーン等）についても言及すること。**)
4.  **更なる改善提案・補足点:** (元の文章に不足していた情報、論理の弱さ、説明不足など、リファクタリングだけでは補いきれないが重要だと感じた点や、代替表現の提案など。**推測した背景情報の根拠や、もし実際の状況と異なる場合に特に注意すべき点についても言及すること。**)

```"##,
        content
    )
}

/// 議事録作成のための構造化ルールとミーティング情報を元に、文字起こしテキストを分析・構造化する
fn create_meeting_doc(content: &str) -> String {
    format!(
        r##"# 指示

以下の情報と構造化ルールに基づき、提供されたミーティングの文字起こしテキストを分析・構造化し、その結果を用いて議事録を作成してください。

# 入力情報

## 1. ミーティング情報（可能な範囲で具体的に入力してください）
*   **会議名/件名:** (例：〇〇プロジェクト定例会議 第5回)
*   **日時:** (例：YYYY年MM月DD日 HH:MM - HH:MM)
*   **場所:** (例：オンライン、第1会議室)
*   **参加者リスト:** (可能であれば役職や役割も)
    *   (例：山田 太郎 (プロジェクトマネージャー))
    *   (例：佐藤 花子 (開発担当))
    *   (例：鈴木 一郎 (営業担当))
*   **ミーティングの目的:** (例：〇〇機能の仕様決定、進捗確認と課題共有)
*   **事前に配布された議題:**
    *   (例：1. 〇〇機能の仕様について)
    *   (例：2. 現在の進捗状況報告)
    *   (例：3. 課題と懸念点の共有)
    *   (例：4. 次回までのアクション確認)
*   **期待する議事録の形式・詳細度:** (例：決定事項・ToDo中心の要点、発言者ごとの詳細記述、報告書形式など)
*   **その他特記事項:** (例：文字起こしデータに一部音声不明瞭箇所あり。特定の話者の発言を重点的に記録したい、など)

## 2. 構造化ルール (議事録作成の基礎情報として使用)
```json
{{
  "タイトル": "会議名/件名 (上記ミーティング情報があれば優先、なければ推測)",
  "要約": "ミーティング全体の目的と主要な結論を簡潔に記述",
  "目的": "ミーティングの目的 (上記ミーティング情報があれば優先、なければ推測)",
  "参加者": ["参加者リスト (上記ミーティング情報があれば優先、なければテキストから抽出)"],
  "議題": ["議題リスト (上記ミーティング情報があれば優先、なければテキストから抽出・推測)"],
  "決定事項": [
    {{"内容": "具体的に何が決まったか", "決定背景・理由": "(任意) テキストから読み取れる範囲で", "関連議題": "(任意) どの議題に関連するか"}}
  ],
  "ToDoリスト(アクションアイテム)": [
    {{"担当者": "誰が", "タスク内容": "何をするか", "期限": "いつまでに"}}
  ],
  "合意事項": [
    {{"内容": "何について合意したか", "合意形成プロセス": "(任意) テキストから読み取れる範囲で"}}
  ],
  "共有事項・報告事項": [
    {{"発言者": "", "内容": "共有・報告された情報"}}
  ],
  "提起された課題・懸念点": [
    {{"提起者": "", "内容": "どのような課題や懸念が提起されたか"}}
  ],
  "その他特筆事項": "上記カテゴリに含まれない重要な情報 (例: 次回会議で議論する事項など)",
  "次回予定": {{"日時": "(未定の場合はその旨)", "議題": "(任意)"}}
    }}
```
## 3. 文字起こしテキスト
```
{}
```

# 出力要件

1.  **構造化データの作成:**
    *   上記の「構造化ルール」に従い、文字起こしテキストと「ミーティング情報」を分析し、JSON形式で情報を整理・抽出してください。
    *   各項目について、テキスト内の具体的な発言や文脈から情報を埋めてください。推測が必要な場合は、その旨がわかるように記述してください (例: 「(推測) 〇〇について」)。
    *   **特に「決定事項」「ToDoリスト」「合意事項」を正確かつ具体的に抽出することに重点を置いてください。**
    *   該当する情報が見つからない項目は `null` または空の配列 `[]` としてください。感情や希望、会話評価といった主観的で判断が難しい項目は、明確な根拠がない限り含めなくて構いません。
    *   参加者名は、可能な限り「ミーティング情報」のリストと照合し、フルネームで記載してください。不明瞭な場合はテキストの表記に従い、[話者不明]などとしてください。
2.  **議事録の作成:**
    *   作成した構造化データに基づき、**「期待する議事録の形式・詳細度」** の指定があればそれに従い、なければ以下の**標準形式**で、自然で分かりやすい文章の議事録を作成してください。
    *   **標準議事録形式:**
        *   **件名:** （会議名/件名）
        *   **日時:**
        *   **場所:**
        *   **参加者:** （敬称略、役職等あれば付記）
        *   **目的:**
        *   **議題:** （箇条書き）
        *   ---
        *   **決定事項:** （箇条書きで具体的に）
        *   **ToDoリスト:** （担当者、タスク内容、期限を明記した表形式または箇条書き）
        *   **合意事項:** （箇条書きで具体的に）
        *   **共有事項・報告事項:** （箇条書き、必要に応じて発言者名を付記）
        *   **提起された課題・懸念点:** （箇条書き、必要に応じて提起者名を付記）
        *   **その他特筆事項:**
        *   **次回予定:**
    *   文字起こしテキストから直接判断できない情報（会議名、日時、場所、目的、議題など）は、「ミーティング情報」を最優先で参照してください。情報がない場合は「不明」と記載してください。
    *   文字起こしテキスト中の不明瞭な箇所（話者、内容）は、議事録にもその旨を注記してください (例: 「[内容不明瞭]」、「玉井氏の発言（一部不明瞭）」など)。
    *   構造化データの内容を忠実に反映しつつ、議事録として読みやすいように体裁を整えてください。"##,
        content
    )
}

/// 文章中の整合性を確認する
fn check_integrity(content: &str) -> String {
    format!(
        r##"# 指示: 長文テキストの超精密 整合性監査と修正案提示

あなたは、論理構造分析、意味解釈、目的適合性評価に特化した、極めて厳格かつ精密な分析を行うAIレビューアです。批判的思考と多角的視点を駆使し、以下のテキストにおけるあらゆるレベルでの整合性の欠如、論理的瑕疵、潜在的リスクを検出・評価する任務を負います。僅かな矛盾、曖昧さ、非一貫性も見逃さず、客観的根拠に基づいた詳細な監査を実施し、その結果に基づいて**可能な限りの修正を反映した全文**をまず提示してください。

## 監査対象テキスト
{}

## 監査実行指示

以下のフェーズに従い、段階的かつ網羅的に監査を実行してください。まず各フェーズで問題を検出・評価し、その情報を保持してください。その後、保持した情報をもとに「出力形式」に沿って出力を生成してください。

**フェーズ 1: 全体構造と戦略的整合性の分析**

1.  **核となる主張/目的の特定:**
    *   この文書が達成しようとする**究極的な目的（Goal）**と、その達成のために設定されている**具体的な目標（Objectives）**を特定し、明記してください。
    *   文書全体の**中心的な主張（Thesis Statement）**または**核心的なメッセージ（Core Message）**を、一文で正確に要約してください。
    *   想定される**主要なターゲット読者層**と、その読者層が持つであろう**前提知識、期待、潜在的疑問**を推測してください。
2.  **マクロ構造評価:**
    *   序論、本論、結論（あるいはそれに準ずる構成要素）が、特定した目的と主張に対して戦略的に配置・機能しているか評価してください。
    *   全体の情報フロー（議論の展開順序）は、論理的に最適化されており、読者の理解を効果的に促進するか評価してください。大きな構成上の弱点や改善点を指摘してください。
3.  **戦略的トーン＆マナー評価:**
    *   文書全体のトーン＆マナー（客観性/主観性の度合い、フォーマル/インフォーマル度、説得/情報提供のバランスなど）は、特定した目的とターゲット読者に対して最適化されているか評価してください。意図しない印象を与える可能性はないか検討してください。

**フェーズ 2: セクション/段落レベルでの論理・意味的整合性検証**

1.  **主張と根拠の連関性:**
    *   各セクション/段落が提示する部分的主張や情報は、フェーズ1で特定した**中心的主張/核心的メッセージ**と明確かつ直接的に関連していますか？関連性の希薄な箇所、あるいは逸脱している箇所を特定してください。
    *   各主張に対して提示されている**根拠（データ、事例、論理的推論など）**は、**必要かつ十分**ですか？根拠の質（信頼性、客観性、最新性など）は妥当ですか？論理的な飛躍、過度の一般化、未証明の前提がないか厳密にチェックしてください。
    *   **論理的誤謬（Fallacy）**（例: ストローマン、人身攻撃、早まった一般化、偽のジレンマなど）が含まれていないか探索してください。
2.  **内部一貫性:**
    *   各セクション/段落内での**主張、定義、用語法**に矛盾や揺らぎはありませんか？
    *   議論の方向性が途中で不意に変わったり、自己矛盾に陥ったりしている箇所はありませんか？
3.  **接続の妥当性:**
    *   セクション間、段落間の**接続詞やトランジション表現**は適切に使用され、論理的な流れを明確に示していますか？接続が不明瞭、あるいは誤解を招く可能性のある箇所を特定してください。

**フェーズ 3: 文/表現レベルでの精密チェック**

1.  **意味の明確性・一義性:**
    *   **曖昧な表現、多義的な単語、解釈が分かれる可能性のある文**を特定してください。特に、重要なキーワードや概念に関して、定義が一貫して適用されているか精密に確認してください。
    *   比喩、類推、例示が、意図した意味を正確に伝え、誤解を招くリスクがないか評価してください。
2.  **用語・概念の一貫性:**
    *   専門用語、略語、固有名詞の**定義と用法**は、文書全体で厳密に統一されていますか？僅かな表記揺れや意味合いの変化も指摘してください。
3.  **前提条件の明示性:**
    *   暗黙の前提となっている事柄で、読者によっては共有されていない可能性のあるものはありませんか？明示的に記述すべき前提条件を指摘してください。

**フェーズ 4: 潜在的リスクと改善提言**

1.  **潜在的誤解・反論リスク:**
    *   ターゲット読者が**誤解する可能性**のある箇所、あるいは**批判や反論を受けやすい**と考えられる論理的弱点や表現を指摘してください。
2.  **目的達成への阻害要因:**
    *   文書のいずれかの部分が、意図せずして**全体の目的達成を阻害**している（例: 読者の反感を買う、信頼性を損なう、混乱を招く）可能性はありませんか？
3.  **総合的な改善提言:**
    *   発見された問題点を解消し、文書全体の整合性、論理性、説得力、明確性を最大化するための**具体的かつ実行可能な改善策**を、優先度をつけて検討してください。構成変更、表現修正、根拠補強、定義明確化など、多岐にわたる提案を検討してください。

## 出力形式

以下の構造化された形式で、監査結果と修正案を報告してください。

1.  **修正案を反映した本文:**
    *   監査で検出された整合性の問題点に基づき、可能な限り修正を適用した全文を出力してください。修正箇所は、可能であれば（例: 太字、下線、[修正理由: ...] の追記など）識別できるようにしてください。ただし、過度に読みづらくならない範囲で実施してください。
    *   **注:** ここに出力されるのはあくまでAIが提案する「修正案」であり、最終的な文章はご自身で判断・編集してください。構成全体に関わる抜本的な修正は、この本文では表現しきれない場合があります。

2.  **監査サマリー:**
    *   **総合評価:** (例: 極めて高い整合性、改善の余地が大きい、重大な欠陥あり など)
    *   **特定された主要な課題:** (最も深刻または影響範囲の広い問題点を3-5点に要約)
    *   **監査対象文書の特定された目的・目標・主張:** (フェーズ1での特定結果)
    *   **想定されるターゲット読者:** (フェーズ1での推測結果)

3.  **詳細監査レポート:**
    *   **(フェーズ1) 全体構造と戦略的整合性:**
        *   [指摘事項、評価、根拠、監査対象テキストにおける具体的な該当箇所（セクション名など）、および修正案（本文で反映済みか、別途検討が必要か）を具体的に記述]
    *   **(フェーズ2) セクション/段落レベルでの論理・意味的整合性:**
        *   [指摘箇所 (該当テキスト引用推奨)、問題の種類 (論理的飛躍、根拠不足、内部矛盾など)、深刻度 (高/中/低)、詳細な分析、修正案（本文で反映済みか、別途検討が必要か）を具体的に記述。複数箇所あればリスト形式で]
    *   **(フェーズ3) 文/表現レベルでの精密チェック:**
        *   [指摘箇所 (該当テキスト引用推奨)、問題の種類 (曖昧性、用語不統一など)、深刻度 (高/中/低)、詳細な分析、修正案（本文で反映済みか、別途検討が必要か）を具体的に記述。複数箇所あればリスト形式で]
    *   **(フェーズ4) 潜在的リスクと改善提言:**
        *   [潜在的リスクの種類 (誤解、反論など)、該当箇所、リスクの詳細、具体的な改善策（本文で反映済みか、別途検討が必要か）を記述]

4.  **監査者所見:**
    *   監査プロセス全体を通じて気づいた特記事項や、文書全体の品質向上に向けた補足的なアドバイスがあれば記述してください。
    *   (オプション) AI自身の分析の確信度や、分析における限界があれば言及してください。
"##,
        content
    )
}
